#include "base64.h"

#include <stdint.h>

static char base64conv[256] =
{
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,

    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 62, -1, -1, -1, 63,
    52, 53, 54, 55, 56, 57, 58, 59,
    60 ,61, -1, -1, -1, -1, -1, -1,

    -1,  0,  1,  2,  3,  4,  5,  6,
     7,  8,  9, 10, 11, 12, 13, 14,
    15, 16, 17, 18, 19, 20, 21, 22,
    23, 24, 25, -1, -1, -1, -1, -1,

    -1, 26, 27, 28, 29, 30, 31, 32,
    33, 34, 35, 36, 37, 38, 39, 40,
    41, 42, 43, 44, 45, 46, 47, 48,
    49, 50, 51, -1, -1, -1, -1, -1,

    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,

    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,

    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,

    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1,
};

int convert_base64(char *txt, size_t src_size, char *buffer, size_t size)
{
    uint32_t v = 0;
    char     c;
    int      idx;
    int      end = 0;
    int      i;

    idx = 0;

    while(src_size) {
        c = base64conv[(int) *txt];
        if(end && *txt != '=')
            return -1;
        if(c == -1) {
            if(*txt != '=')
                return -1;
            end++;
            c = 0;
        }
        v = (v << 6) | c;

        idx++;
        if(idx == 4) {
            if((signed) size < 3 - end)
                return -1;
            for(i = 3; i-- != end;) {
                *buffer = (v >> (i * 8)) & 0xFF;
                size--;
                buffer++;
            }
            v   = 0;
            idx = 0;
        }
        txt++;
        src_size--;
    }

    if(size)
        *buffer = 0;

    return 0;
}
